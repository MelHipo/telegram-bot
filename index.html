<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü—Ä–∏—ë–º–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            width: 100%;
            background-color: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .back-button {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0 8px;
            display: none;
        }
        
        .back-button.visible {
            display: block;
        }
        
        .header-title {
            font-size: 18px;
            font-weight: 500;
            flex: 1;
        }
        
        .content {
            padding: 16px;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        /* –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ */
        .object-select, .fio-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 16px;
        }
        
        .object-select:focus, .fio-input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .fio-input {
            margin-top: 8px;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            width: 100%;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn:active {
            background-color: #2980b9;
        }
        
        .btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
        }
        
        .btn-secondary:active {
            background-color: #7f8c8d;
        }
        
        /* –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ */
        .zayavka-card {
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
        }
        
        .zayavka-card:active {
            transform: scale(0.99);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .zayavka-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .zayavka-nomer {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
        }
        
        .zayavka-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 16px;
            background-color: #f39c12;
            color: white;
        }
        
        .status-processing { background-color: #f39c12; }
        .status-partial { background-color: #3498db; }
        .status-full { background-color: #27ae60; }
        .status-done { background-color: #95a5a6; }
        
        .zayavka-info {
            display: flex;
            gap: 16px;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .progress-bar {
            height: 4px;
            background-color: #ecf0f1;
            border-radius: 2px;
            margin-top: 12px;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #27ae60;
            border-radius: 2px;
            width: 0%;
        }
        
        /* –°–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ */
        .material-card {
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .material-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .material-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        .material-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 16px;
            color: white;
        }
        
        .status-waiting { background-color: #95a5a6; }
        .status-delivery { background-color: #3498db; }
        .status-accepted { background-color: #27ae60; }
        .status-rejected { background-color: #e74c3c; }
        
        .material-details {
            display: flex;
            gap: 16px;
            font-size: 14px;
            color: #7f8c8d;
            margin: 8px 0;
        }
        
        .accept-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            width: 100%;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .accept-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        /* –§–æ—Ä–º–∞ –ø—Ä–∏—ë–º–∫–∏ */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        
        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .comment-field {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            min-height: 80px;
            resize: vertical;
            margin-top: 12px;
        }
        
        .brak-field {
            display: none;
            margin-top: 12px;
        }
        
        .brak-field.visible {
            display: block;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }
        
        .error-message.visible {
            display: block;
        }
        
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }
        
        .success-message.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <button class="back-button" id="backBtn">‚Üê</button>
            <div class="header-title" id="headerTitle">–ü—Ä–∏—ë–º–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</div>
        </div>
        
        <div class="content" id="content">
            <!-- –≠–∫—Ä–∞–Ω 1: –í—Ö–æ–¥ -->
            <div class="screen active" id="screenLogin">
                <h2 style="margin-bottom: 20px;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
                
                <div class="error-message" id="loginError"></div>
                
                <div class="form-group">
                    <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç</label>
                    <select class="object-select" id="objectSelect">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–í–∞—à–µ –§–ò–û</label>
                    <input type="text" class="fio-input" id="fioInput" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á">
                </div>
                
                <button class="btn" id="startBtn" disabled>–ù–∞—á–∞—Ç—å –ø—Ä–∏—ë–º–∫—É</button>
            </div>
            
            <!-- –≠–∫—Ä–∞–Ω 2: –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ -->
            <div class="screen" id="screenZayavki">
                <div class="error-message" id="zayavkiError"></div>
                <div class="loading" id="zayavkiLoading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...</div>
                <div id="zayavkiList"></div>
            </div>
            
            <!-- –≠–∫—Ä–∞–Ω 3: –î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏ -->
            <div class="screen" id="screenDetails">
                <div class="error-message" id="detailsError"></div>
                <div class="loading" id="detailsLoading">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤...</div>
                <div id="materialsList"></div>
            </div>
            
            <!-- –≠–∫—Ä–∞–Ω 4: –§–æ—Ä–º–∞ –ø—Ä–∏—ë–º–∫–∏ -->
            <div class="screen" id="screenAccept">
                <div class="error-message" id="acceptError"></div>
                <div class="success-message" id="acceptSuccess"></div>
                
                <div id="acceptForm"></div>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const API_BASE_URL = 'https://telegram-bot-pjn4.onrender.com';
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let state = {
            objects: [],
            selectedObject: null,
            fio: '',
            currentZayavki: [],
            currentZayavka: null,
            currentMaterial: null
        };
        
        // Telegram WebApp
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.expand(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
            tg.enableClosingConfirmation(); // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        }
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const screens = {
            login: document.getElementById('screenLogin'),
            zayavki: document.getElementById('screenZayavki'),
            details: document.getElementById('screenDetails'),
            accept: document.getElementById('screenAccept')
        };
        
        const backBtn = document.getElementById('backBtn');
        const headerTitle = document.getElementById('headerTitle');
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        async function loadObjects() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/objects`);
                const data = await response.json();
                
                if (data.success) {
                    state.objects = data.objects;
                    const select = document.getElementById('objectSelect');
                    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç</option>' + 
                        data.objects.map(obj => 
                            `<option value="${obj.code}">${obj.name} (${obj.code})</option>`
                        ).join('');
                    
                    document.getElementById('startBtn').disabled = true;
                } else {
                    showError('loginError', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤');
                }
            } catch (error) {
                showError('loginError', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        }
        
        // –í—Ö–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        document.getElementById('objectSelect').addEventListener('change', (e) => {
            state.selectedObject = e.target.value;
            checkStartButton();
        });
        
        document.getElementById('fioInput').addEventListener('input', (e) => {
            state.fio = e.target.value.trim();
            checkStartButton();
        });
        
        function checkStartButton() {
            const btn = document.getElementById('startBtn');
            btn.disabled = !(state.selectedObject && state.fio);
        }
        
        document.getElementById('startBtn').addEventListener('click', async () => {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –§–ò–û –∏ –æ–±—ä–µ–∫—Ç
            localStorage.setItem('lastFio', state.fio);
            localStorage.setItem('lastObject', state.selectedObject);
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ø–∏—Å–∫—É –∑–∞—è–≤–æ–∫
            showScreen('zayavki', `–ó–∞—è–≤–∫–∏: ${state.selectedObject}`);
            await loadZayavki();
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫
        async function loadZayavki() {
            showLoading('zayavkiLoading', true);
            hideError('zayavkiError');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/zayavki?object=${state.selectedObject}`);
                const data = await response.json();
                
                if (data.success) {
                    state.currentZayavki = data.zayavki;
                    renderZayavki();
                } else {
                    showError('zayavkiError', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫');
                }
            } catch (error) {
                showError('zayavkiError', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            } finally {
                showLoading('zayavkiLoading', false);
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫
        function renderZayavki() {
            const list = document.getElementById('zayavkiList');
            
            if (state.currentZayavki.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #7f8c8d;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫</p>';
                return;
            }
            
            list.innerHTML = state.currentZayavki.map(z => {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                let statusClass = 'status-processing';
                let statusText = '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ';
                
                if (z.status === '–ß–∞—Å—Ç–∏—á–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞') {
                    statusClass = 'status-partial';
                    statusText = '–ß–∞—Å—Ç–∏—á–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞';
                } else if (z.status === '–ü–æ–ª–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞') {
                    statusClass = 'status-full';
                    statusText = '–ü–æ–ª–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞';
                }
                
                return `
                    <div class="zayavka-card" onclick="selectZayavka('${z.nomer}')">
                        <div class="zayavka-header">
                            <span class="zayavka-nomer">${z.nomer}</span>
                            <span class="zayavka-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="zayavka-info">
                            <span>üìÖ ${z.date || '–ù–µ—Ç –¥–∞—Ç—ã'}</span>
                            <span>üë§ ${z.responsible || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // –í—ã–±–æ—Ä –∑–∞—è–≤–∫–∏
        window.selectZayavka = async (nomer) => {
            state.currentZayavka = nomer;
            showScreen('details', nomer);
            await loadMaterials(nomer);
        };
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∑–∞—è–≤–∫–∏
        async function loadMaterials(nomer) {
            showLoading('detailsLoading', true);
            hideError('detailsError');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/zayavka/${encodeURIComponent(nomer)}`);
                const data = await response.json();
                
                if (data.success) {
                    renderMaterials(data.pozicii);
                } else {
                    showError('detailsError', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤');
                }
            } catch (error) {
                showError('detailsError', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            } finally {
                showLoading('detailsLoading', false);
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
        function renderMaterials(materials) {
            const list = document.getElementById('materialsList');
            
            list.innerHTML = materials.map(m => {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –º–∞—Ç–µ—Ä–∏–∞–ª–∞
                let statusClass = 'status-waiting';
                let statusText = '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ';
                
                if (m.status === '–î–æ—Å—Ç–∞–≤–∫–∞') {
                    statusClass = 'status-delivery';
                    statusText = '–î–æ—Å—Ç–∞–≤–∫–∞';
                } else if (m.status === '–ü—Ä–∏–Ω—è—Ç') {
                    statusClass = 'status-accepted';
                    statusText = '‚úì –ü—Ä–∏–Ω—è—Ç';
                } else if (m.status === '–ë—Ä–∞–∫') {
                    statusClass = 'status-rejected';
                    statusText = '‚úó –ë—Ä–∞–∫';
                }
                
                const canAccept = m.status !== '–ü—Ä–∏–Ω—è—Ç' && m.status !== '–ë—Ä–∞–∫';
                
                return `
                    <div class="material-card">
                        <div class="material-header">
                            <span class="material-name">${m.naim}</span>
                            <span class="material-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="material-details">
                            <span>üì¶ –ó–∞–∫–∞–∑–∞–Ω–æ: ${m.kolvo_zakaz} ${m.ed_izm || ''}</span>
                            ${m.kolvo_fakt ? `<span>‚úÖ –ü—Ä–∏–Ω—è—Ç–æ: ${m.kolvo_fakt}</span>` : ''}
                        </div>
                        ${canAccept ? 
                            `<button class="accept-btn" onclick="showAcceptForm('${m.naim}', '${m.kolvo_zakaz}', '${m.ed_izm || ''}')">
                                –ü—Ä–∏–Ω—è—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª
                             </button>` : 
                            ''
                        }
                    </div>
                `;
            }).join('');
        }
        
        // –ü–æ–∫–∞–∑ —Ñ–æ—Ä–º—ã –ø—Ä–∏—ë–º–∫–∏
        window.showAcceptForm = (naim, kolvoZakaz, edIzm) => {
            state.currentMaterial = { naim, kolvoZakaz, edIzm };
            
            const form = document.getElementById('acceptForm');
            form.innerHTML = `
                <h3 style="margin-bottom: 16px;">${naim}</h3>
                
                <div class="form-group">
                    <label class="form-label">–ó–∞–∫–∞–∑–∞–Ω–æ: ${kolvoZakaz} ${edIzm}</label>
                    <input type="number" class="form-input" id="acceptKolvo" value="${kolvoZakaz}" min="0" step="1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ö–∞—á–µ—Å—Ç–≤–æ</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="quality" value="OK" checked> ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="quality" value="–ë—Ä–∞–∫"> ‚ùå –ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç
                        </label>
                    </div>
                </div>
                
                <div class="brak-field" id="brakField">
                    <textarea class="comment-field" id="brakComment" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É..."></textarea>
                </div>
                
                <button class="btn" onclick="submitAccept()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø—Ä–∏—ë–º–∫—É</button>
            `;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –¥–ª—è –±—Ä–∞–∫–∞
            document.querySelectorAll('input[name="quality"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const brakField = document.getElementById('brakField');
                    if (e.target.value === '–ë—Ä–∞–∫') {
                        brakField.classList.add('visible');
                    } else {
                        brakField.classList.remove('visible');
                    }
                });
            });
            
            showScreen('accept', '–ü—Ä–∏—ë–º–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞');
        };
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏—ë–º–∫–∏
        window.submitAccept = async () => {
            const kolvo = document.getElementById('acceptKolvo').value;
            const quality = document.querySelector('input[name="quality"]:checked').value;
            const komment = quality === '–ë—Ä–∞–∫' ? document.getElementById('brakComment').value : '';
            
            if (!kolvo || kolvo <= 0) {
                alert('–£–∫–∞–∂–∏—Ç–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ');
                return;
            }
            
            if (quality === '–ë—Ä–∞–∫' && !komment) {
                alert('–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É');
                return;
            }
            
            hideError('acceptError');
            hideSuccess('acceptSuccess');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/priemka`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nomer_zayavki: state.currentZayavka,
                        naim_materiala: state.currentMaterial.naim,
                        kolvo_fakt: kolvo,
                        kachestvo: quality,
                        kommentariy: komment,
                        fio: state.fio
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('acceptSuccess', '–ü—Ä–∏—ë–º–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
                    setTimeout(() => {
                        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º
                        showScreen('details', state.currentZayavka);
                        loadMaterials(state.currentZayavka);
                    }, 1500);
                } else {
                    showError('acceptError', data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
            } catch (error) {
                showError('acceptError', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        };
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function showScreen(screenName, title) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screens[screenName].classList.add('active');
            
            headerTitle.textContent = title || '–ü—Ä–∏—ë–º–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤';
            
            if (screenName === 'login') {
                backBtn.classList.remove('visible');
            } else {
                backBtn.classList.add('visible');
            }
        }
        
        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.add('visible');
        }
        
        function hideError(elementId) {
            const el = document.getElementById(elementId);
            el.classList.remove('visible');
        }
        
        function showSuccess(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.add('visible');
        }
        
        function hideSuccess(elementId) {
            const el = document.getElementById(elementId);
            el.classList.remove('visible');
        }
        
        function showLoading(elementId, show) {
            const el = document.getElementById(elementId);
            if (show) {
                el.style.display = 'block';
            } else {
                el.style.display = 'none';
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥
        backBtn.addEventListener('click', () => {
            if (screens.accept.classList.contains('active')) {
                showScreen('details', state.currentZayavka);
            } else if (screens.details.classList.contains('active')) {
                showScreen('zayavki', `–ó–∞—è–≤–∫–∏: ${state.selectedObject}`);
            } else if (screens.zayavki.classList.contains('active')) {
                showScreen('login', '–ü—Ä–∏—ë–º–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤');
            }
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const lastFio = localStorage.getItem('lastFio');
        const lastObject = localStorage.getItem('lastObject');
        
        if (lastFio) {
            document.getElementById('fioInput').value = lastFio;
            state.fio = lastFio;
        }
        
        // –ó–∞–ø—É—Å–∫
        loadObjects();
        
        if (lastObject) {
            setTimeout(() => {
                const select = document.getElementById('objectSelect');
                select.value = lastObject;
                state.selectedObject = lastObject;
                checkStartButton();
            }, 500);
        }
    </script>
</body>
</html>
